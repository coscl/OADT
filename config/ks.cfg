# Kickstart file automatically generated by anaconda.

#version=DEVEL
nobody --enable
install
url --url="ftp://192.168.1.1/pub"
#lang en_US.UTF-8
lang zh_CN
keyboard us
#network --onboot yes  
rootpw  --iscrypted $6$ATHwHDpTWYAMB/nI$g5c.jpNNtIpjqJb3H39iadaEg7bdlf/xLgcSMs5JhkaKxChTK.Q20fnco8LJh.eNvjLlJLod0paVG1F8BZSnP0
firewall --disabled
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone Asia/Shanghai
bootloader --location=mbr --driveorder=vda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all --drives=vda


#part /boot --fstype=ext4 --size=500
#part swap --grow --maxsize=2368 --size=1184
#part / --fstype=ext4 --grow --maxsize=51200 --size=1024
clearpart --all --initlabel                                   
part /boot --fstype="ext4" --size=100                        
part swap --fstype="swap" --size=2048                       
part / --fstype="ext4" --grow --size=1

reboot

%packages
@Backup-Tools
@base
@chinese-support
@client-mgmt-tools
@console-internet
@core
@Database-tool
@debugging
@basic-desktop
@desktop-debugging
@desktop-platform
@development
@directory-client
@fonts
@general-desktop
@graphical-admin-tools
@hardware-monitoring
@input-methods
@internet-browser
@JDK
@java-platform
@Kernel-tool
@LVS
@large-systems
@legacy-x
@Middleware-tool
@mysql-client
@mysql
@nfs-file-server
@network-file-system-client
@php
@performance
@perl-runtime
@print-client
@remote-desktop-clients
@server-platform
@server-policy
@Manual
@virtualization
@virtualization-client
@virtualization-platform
@Webmin
@x11
nss_db
mtools
pax
oddjob
sgpio
genisoimage
wodim
expect
jpackage-utils
certmonger
openldap-clients
pam_krb5
krb5-workstation
nscd
pam_ldap
nss-pam-ldapd
icedtea-web
libXmu
libXp
libdbi-dbd-mysql
php-mysql
perl-LDAP
perl-DBD-SQLite
perl-Date-Calc
perl-Date-Manip
%end

%post --nochroot

echo "
DEVICE=eth0
BOOTPROTO=none
NM_CONTROLLED=yes
ONBOOT=yes
TYPE=Ethernet
IPADDR=10.1.81.139
NETMASK=255.255.252.0
GATEWAY=10.1.80.254
DNS1=8.8.8.8
IPV6INIT=no
USERCTL=no
" > /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-eth0

echo "(@-@) (@_@)" >> /mnt/sysimage/etc/hosts
echo "myip myhostname" >> /mnt/sysimage/etc/hosts


rm -rf /mnt/sysimage/etc/yum.repos.d/*

touch /mnt/sysimage/etc/yum.repos.d/openstack.repo
echo "
[openstack]
name=openstack
baseurl=ftp://127.0.0.1/openstack-repo/openstack-packages
enabled=1
gpgcheck=0
" > /mnt/sysimage/etc/yum.repos.d/openstack.repo

mkdir -p /mnt/sysimage/opt/openstack

touch /mnt/sysimage/opt/openstack/start.sh

echo "
sed -i '/HOSTNAME=/d' /etc/sysconfig/network
echo \"HOSTNAME=myhostname\" >> /etc/sysconfig/network
hostname myhostname
service NetworkManager stop
chkconfig NetworkManager off
mkdir -p /root/.ssh/
chmod 700 /root/.ssh/
yum install -y telnet telnet-server puppet facter
sed -i "s/disable.*/disable  = no /g" /etc/xinetd.d/telnet
service xinetd start
chkconfig xinetd on
echo \"listen=true\" >> /etc/puppet/puppet.conf
echo \"PUPPET_SERVER=(@_@)\" >> /etc/sysconfig/puppet
touch /etc/puppet/namespaceauth.conf
echo \"[puppetrunner]\" > /etc/puppet/namespaceauth.conf
echo \"allow *\" >> /etc/puppet/namespaceauth.conf
sed -i '/path \/$/d' /etc/puppet/auth.conf
sed -i '/auth any/d' /etc/puppet/auth.conf
echo \"
path /run
method save
allow *
path /
auth any 
\" >> /etc/puppet/auth.conf
/etc/init.d/puppet stop
puppetd --server=(@_@)
chkconfig puppet on
ntpdate (@-@)
telnet (@-@) &
sleep 2
echo \"myhostname:installed\" | nc (@-@) 6666
echo \"myhostname has installed\" >> /tmp/tmp.txt
" > /mnt/sysimage/opt/openstack/start.sh

echo "sh /opt/openstack/start.sh" >> /mnt/sysimage/etc/rc.local
